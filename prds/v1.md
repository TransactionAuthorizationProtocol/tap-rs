Below is the complete markdown file. You can save this content as, for example, `Rust_TAP_PRD.md`:

---

# Rust TAP Implementation PRD and Best Practices

This document outlines the product requirements for a Rust implementation of the Transaction Authorization Protocol (TAP), targeting payment-related use cases and Travel Rule messaging. The project is structured as a Rust workspace with multiple crates. Each item below is represented as a checklist (using markdown checkboxes) to track progress. Additionally, best practices for Rust development and references/URLs to useful specifications are provided at each step.

---

## Project Requirements

### General
- [x] **Rust Workspace:**  
    - [x] Create a Rust workspace adding tap-core initially as a library crate.
    - [x] Create a good .gitignore file to avoid unnecessary files in the repo.

### tap-core (TAP Core Message Processing)
- [x] **DIDComm Integration:**  
  - [x] Integrate with a Rust DIDComm v2 library to create and parse a DIDComm message (e.g. [didcomm](https://crates.io/crates/didcomm)).  
  - [x] Allow vendor/forking if needed for WASM support.  
  - **Reference:** [DIDComm Messaging Spec](https://identity.foundation/didcomm-messaging/spec/)
- [x] **TAP Message Structs:**  
  - [x] Define Rust structs/enums for all TAP message types per spec.  
  - **Reference:** [TAP Spec](https://tap.rsvp) and [TAIPs Repository](https://github.com/TransactionAuthorizationProtocol/TAIPs)
- [x] **Message Parsing:**  
  - [x] Convert incoming plaintext DIDComm messages into corresponding TAP message structs and validate required fields.
- [x] **Message Construction:**  
  - [x] Create outgoing DIDComm messages by serializing TAP structs into Plaintext DIDComm messages
- [x] **WASM Compatibility:**  
  - [x] Ensure all cryptographic dependencies are WASM-friendly and the crate compiles for the `wasm32` target.
- [x] **Message validation**
  - [x] Make sure that proper CAIP-10 and CAIP-19 identifiers are used in TAP messages.
- [x] **Performance Optimization:**  
  - [x] Optimize parsing and message packing for high throughput (aim for thousands of messages per second).
- [x] **Extensibility:**  
  - [x] Structure message handling to easily allow new TAP message types or protocol versions.
- [x] **Unit Tests:**  
  - [x] Develop tests for each message type conversion and validation.
- [x] **Fuzz Testing:**  
  - [x] Implement fuzz tests for message parsing against malformed or malicious inputs.
- [x] **Integration Tests:**  
  - [x] Create tests for round-trip messaging (pack → send → unpack) and interoperability with sample messages.

### tap-agent (TAP Agent Functionality)
- [x] **Agent Identity (DID):**  
  - [x] Represent a TAP agent with a DID and associated keys; provide functionality for loading/configuring a DID document.
  - [x] Stateless with no storage
- [x] **Security (Integrity & Privacy):**  
  - [x] Support signing and authcrypt mechanisms; verify signatures and decrypt incoming messages.
- [x] **Message specific encryption or signing**
  - [x] By default use message signing for all messages except for Presentation messages which should be encrypted using authcrypt.
- [x] **Message Signing:**  
  - [x] Implement asynchronous signing and encryptionof outgoing TAP messages with the agent's private key.  
  - [x] Abstract signing via traits to support integration with HSMs or secure enclaves.
- [x] **Message Sending and Receiving:**
  - [x] Allow a callback to be configured for sending outgoing messages (this should be a simple function call and can be implemented by the node in tap-node).
  - [x] Implement a mechanism for the agent to receive incoming messages (this should be a simple function call and can be implemented by the node in tap-node to call on the agent).
- [x] **Message Decryption & Verification:**  
  - [x] Enable the agent to decrypt, and verify DIDComm messages; validate sender DID and signature.
- [x] **DID-Based Routing:**  
  - [x] Extract and expose sender/receiver information from DIDComm messages.
- [x] **Policy Handling (Extensibility):**  
  - [x] Provide placeholders or interfaces for future policy checks (e.g. Travel Rule thresholds, allow/block lists).
- [x] **Async Crypto Support:**  
  - [x] Ensure all cryptographic operations are asynchronous and non-blocking.
- [x] **WASM-Friendly Implementation:**  
  - [x] Confirm that core agent logic compiles to WASM (excluding HSM-specific integrations).
- [x] **Extensibility:**  
  - [x] Design the agent interface to support additional roles or new TAIP message types.
- [x] **Unit Tests:**  
  - [x] Write tests for signing, decryption, and message verification.
- [x] **Integration Tests:**  
  - [x] Test end-to-end scenarios with tap-core (e.g. an agent signing a message that another verifies).

### tap-caip (Chain Agnostic Identifiers)
- [x] **CAIP-2 (Chain ID):**  
  - [x] Implement parsing/serialization for CAIP-2 identifiers (format: `<namespace>:<reference>`).  
  - **Reference:** [CAIPs Repository](https://github.com/ChainAgnostic/CAIPs)
- [x] **CAIP-10 (Account ID):**  
  - [x] Implement CAIP-10 for account identifiers (format: `<CAIP-2 chain id>:<account address>`); validate address formats.
- [x] **CAIP-19 (Asset ID):**  
  - [x] Implement CAIP-19 for asset identifiers (format: `<CAIP-2 chain id>/<asset namespace>:<asset reference>`).
- [x] **(Optional) CAIP-74:**  
  - [x] Add support for CAIP-74 (Capability Objects) if needed by future extensions.
- [x] **(Optional) CAIP-122:**  
  - [x] Add support for CAIP-122 (Sign-In with X) for wallet authentication if required.
- [x] **WASM Compatibility:**  
  - [x] Ensure the tap-caip library compiles to WASM without non-compatible dependencies.
- [x] **Unit Tests:**  
  - [x] Create tests for valid and invalid CAIP strings (CAIP-2, CAIP-10, CAIP-19).
- [x] **Fuzz Testing:**  
  - [x] Implement fuzz testing for the CAIP module to validate handling of malformed identifiers.
- [x] **Documentation:**  
  - [x] Document supported CAIP formats with examples for developers.

### tap-node (TAP Node Orchestration)
- [x] **Multi-Agent Management:**  
  - [x] Implement registration and management of multiple tap-agent instances within the node.
- [x] **DID Routing Table:**  
  - [x] Maintain a mapping of agent DIDs to their corresponding tap-agent instances.
- [x] **Incoming Message Dispatch:**  
  - [x] Decrypt, verify, and dispatch incoming DIDComm messages to the appropriate agent.
- [x] **Outgoing Message Dispatch:**  
  - [x] Provide a mechanism for agents to send messages via the node (pack, encrypt, transmit).
- [x] **Tokio Subscription (Event Bus):**  
  - [x] Implement an internal publish/subscribe system using Tokio channels for TAP events.
- [x] **Concurrency & Throughput:**  
  - [x] Utilize Tokio tasks to process messages concurrently and scale under high load.
- [x] **DID Resolution Support:**  
  - [x] Provide a callback/mechanism for resolving DID Documents (fetch public keys for unknown DIDs).
- [x] **Storage & Persistence:**  
  - [x] Establish an optional abstract logging mechanism for persisting TAP messages by subscribing to all events.
- [x] **Extensibility:**  
  - [x] Structure node logic to allow easy addition of new message flows or roles.
- [x] **WASM Consideration:**  
  - [x] Ensure core node functionality can compile to WASM (with feature flags for non-WASM-specific functionality).
- [x] **Unit Tests:**  
  - [x] Develop tests for routing, dispatch, and event subscription functionality.
- [x] **Integration Tests:**  
  - [x] Simulate a mini network (multiple agents exchanging messages) to verify end-to-end operations.
- [x] **Fuzz/Stress Testing:**  
  - [x] Conduct stress tests by simulating high-volume message loads to identify potential bottlenecks.

### tap-http (HTTP DIDComm Server)
- [x] **Warp HTTP Endpoint:**  
  - [x] Implement a Warp-based HTTP server exposing a public DIDComm endpoint (e.g. `POST /didcomm`).  
  - **Reference:** [Warp GitHub Repository](https://github.com/seanmonstar/warp)
- [x] **Request Handling:**  
  - [x] Parse and validate incoming HTTP requests containing DIDComm messages, and delegate them to tap-node.
- [x] **Response Mechanics:**  
  - [x] Implement appropriate response handling (acknowledgment, error responses) per DIDComm conventions.
- [x] **Integration with tap-node:**  
  - [x] Ensure tap-http initializes a tap-node instance and delegates message processing accordingly.
- [x] **Outgoing Message Delivery:**  
  - [x] Provide functionality to send outgoing DIDComm messages via HTTP POST to peer endpoints.
- [x] **Security (Network):**  
  - [x] Support HTTPS/TLS (or assume a reverse proxy) and implement basic protections (e.g. rate limiting).
- [x] **High Throughput Server:**  
  - [x] Configure Warp and Tokio for high concurrency and low latency.
- [x] **Extensibility & Configurability:**  
  - [x] Allow configuration of server parameters (port, CORS, endpoint paths, etc.).
- [x] **Unit/Component Tests:**  
  - [x] Write tests for HTTP handlers and message processing.
- [x] **Integration Tests:**  
  - [x] Conduct end-to-end tests for complete DIDComm message cycles.
- [x] **Interoperability Test:**  
  - Test with another TAP implementation to ensure compliance with DIDComm and TAP specifications.

### tap-ts (TypeScript WASM Wrapper)
- [x] **WASM Build of Core:**  
  - Compile core TAP logic (tap-node and tap-agent) into WebAssembly using [wasm-bindgen](https://rustwasm.github.io/wasm-bindgen/) or [wasm-pack](https://rustwasm.github.io/wasm-pack/).
  - Create a tap-wasm crate for building the compiled WASM module.
- [x] **Build environment**
  - [x] Use deno 2.2 for the project to make it simpler to build and deploy the code
- [x] **WASM Interface:**  
  - Create TypeScript wrapper for the WASM bindings.
  - Provide TypeScript definition files (.d.ts).
- [x] **Browser Agent Usage:**  
  - Enable browser scenarios where a self-custodied wallet acts as a TAP agent (e.g. key generation/import, message encryption/decryption).
- [x] **DID support:**
    - [x] Use `did-resolver` npm package
    - [x] Use npm packages for other DID methods (e.g. `did-key`, `did-pkh`, `did-web`, `did-ethr`)
- [x] **Minimal Dependencies:**  
  - Ensure that the TS wrapper has minimal external dependencies besides the WASM build.
- [x] **Web Crypto Integration (Optional):**  
  - [x] Allow the use of Web Crypto API for cryptographic operations where possible.
- [x] **Documentation:**  
  - Provide clear documentation for using the TS wrapper.
  - Include examples for common use cases.
- [x] **Tests:**  
  - Comprehensive tests for the TypeScript wrapper functions.
  - Browser-based tests for validating WASM functionality.
- [x] **Benchmarks:**  
  - [x] Performance benchmarks for the TS wrapper.
  - [x] Metrics on message throughput in browser environments.
- [x] **Build Tools:**  
  - [x] Simplify packaging and distribution.
  - [x] Easy integration with web bundlers (webpack, rollup, etc.).

### Testing & Validation Milestones (Cross-Crate)
- [x] **End-to-End Integration Test:**  
  - [x] Simulate a complete TAP workflow (e.g. Originator VASP ↔ Beneficiary VASP) across tap-core, tap-agent, tap-node, and tap-http.
- [x] **Performance Benchmarking:**  
  - [x] Set up benchmarks to measure throughput (messages per second) and latency under high concurrent loads.
- [x] **Security Audit & Fuzzing:**  
  - [x] Implement fuzz testing for the CAIP module to validate handling of malformed identifiers.
  - [x] Integrate CAIP validation into the tap-core crate to ensure consistent use of chain, account, and asset identifiers.
  - [x] Conduct a thorough security review and extended fuzz testing (e.g. using [cargo-fuzz](https://github.com/rust-fuzz/cargo-fuzz)) on all message handling interfaces.
- [x] **Compliance Testing:**  
  - [x] Validate conformance with TAP, DIDComm, and CAIP specifications via official test vectors or interoperability tests.
- [x] **Documentation & Developer Guide:**  
  - [x] Update README and inline documentation for each crate with usage examples and API details.

---

## Rust Development Best Practices

- **Code Formatting:**  
  - Use `rust fmt` to ensure code is consistently formatted.  
  - **Reference:** [Rustfmt GitHub](https://github.com/rust-lang/rustfmt)
- **Linting:**  
  - Utilize `clippy` for catching common mistakes and enforcing idiomatic Rust patterns.  
  - **Reference:** [Clippy Book](https://rust-lang.github.io/rust-clippy/)
- **Testing:**  
  - Write unit tests, integration tests, and fuzz tests for all critical modules.  
  - Use `cargo test` for automated testing.
- **Documentation:**  
  - Document public APIs using Rust doc comments and generate documentation with `cargo doc`.
- **Error Handling:**  
  - Use `Result` and proper error types. Consider libraries like [`thiserror`](https://crates.io/crates/thiserror) for easier error management.
- **Dependency Management:**  
  - Manage dependencies via Cargo; prefer libraries that are actively maintained and WASM-friendly.
- **Async Programming:**  
  - Leverage the Tokio runtime for asynchronous operations and consider using async/await for readability.
- **Security:**  
  - Use vetted cryptographic libraries and review security practices for key management (especially for signing and encryption operations).
- **Modularity & Extensibility:**  
  - Design components as small, testable units; use traits and generics to allow future extensions.
- **Performance:**  
  - Profile performance, especially for high-throughput scenarios. Use benchmarks and tools like `cargo bench`.

---

## References & Useful Links

- **TAP Protocol:**  
  - [TAP Spec](https://tap.rsvp)  
  - [TAIPs Repository](https://github.com/TransactionAuthorizationProtocol/TAIPs)
- **DIDComm:**  
  - [DIDComm Messaging Spec](https://identity.foundation/didcomm-messaging/spec/)
- **CAIP Specifications:**  
  - [Chain Agnostic Improvement Proposals (CAIPs)](https://github.com/ChainAgnostic/CAIPs)
- **Rust Development:**  
  - [The Rust Programming Language (Book)](https://doc.rust-lang.org/book/)  
  - [Rust API Guidelines](https://rust-lang.github.io/api-guidelines/)
- **WASM in Rust:**  
  - [The Rust and WebAssembly Book](https://rustwasm.github.io/book/)
- **Async & Tokio:**  
  - [Tokio Documentation](https://tokio.rs/tokio/tutorial)
- **Warp:**  
  - [Warp GitHub Repository](https://github.com/seanmonstar/warp)
- **wasm-bindgen & wasm-pack:**  
  - [wasm-bindgen](https://rustwasm.github.io/wasm-bindgen/)  
  - [wasm-pack](https://rustwasm.github.io/wasm-pack/)

---

This markdown file serves both as a detailed checklist for the Rust TAP implementation and as a guide to best practices and resources for Rust development. Each checkbox represents a specific feature or best practice to be implemented and verified during development.
