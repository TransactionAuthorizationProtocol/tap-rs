<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TAP Agent Browser Example</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .agent-section {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      background: #f9f9f9;
    }
    
    .agent-section h2 {
      margin-top: 0;
      color: #4a5568;
    }
    
    .did {
      font-family: 'Courier New', monospace;
      background: #2d3748;
      color: #48bb78;
      padding: 8px 12px;
      border-radius: 4px;
      word-break: break-all;
      display: inline-block;
      margin: 10px 0;
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-right: 10px;
      margin-top: 10px;
      transition: background 0.3s;
    }
    
    button:hover {
      background: #5a67d8;
    }
    
    button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
    }
    
    .message-log {
      background: #1a202c;
      color: #68d391;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    
    .message-entry {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #2d3748;
    }
    
    .message-entry:last-child {
      border-bottom: none;
    }
    
    .timestamp {
      color: #718096;
      font-size: 12px;
    }
    
    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      color: #4a5568;
      font-weight: 500;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .stat-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 15px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-label {
      color: #718096;
      font-size: 14px;
      margin-top: 5px;
    }
    
    .error {
      background: #fed7d7;
      color: #c53030;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    
    .success {
      background: #c6f6d5;
      color: #22543d;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê TAP Agent Browser Demo</h1>
    <p class="subtitle">Transaction Authorization Protocol - DIDComm v2 Messaging</p>
    
    <!-- Agent 1 Section -->
    <div class="agent-section">
      <h2>Agent 1 (Alice)</h2>
      <button id="createAgent1">Create Agent</button>
      <button id="exportKey1" disabled>Export Private Key</button>
      <div id="agent1Info"></div>
      
      <div id="agent1Forms" style="display: none;">
        <h3>Send Transfer</h3>
        <div class="form-group">
          <label>Amount</label>
          <input type="number" id="transferAmount" value="100.00" step="0.01">
        </div>
        <div class="form-group">
          <label>Asset</label>
          <select id="transferAsset">
            <option value="eip155:1/erc20:0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48">USDC (Ethereum)</option>
            <option value="eip155:137/erc20:0x2791bca1f2de4661ed88a30c99a7a9449aa84174">USDC (Polygon)</option>
            <option value="USD">USD (Fiat)</option>
            <option value="EUR">EUR (Fiat)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Memo</label>
          <input type="text" id="transferMemo" value="Test transfer">
        </div>
        <button id="sendTransfer">Send Transfer to Agent 2</button>
      </div>
    </div>
    
    <!-- Agent 2 Section -->
    <div class="agent-section">
      <h2>Agent 2 (Bob)</h2>
      <button id="createAgent2">Create Agent</button>
      <button id="exportKey2" disabled>Export Private Key</button>
      <button id="importKey2">Import from Private Key</button>
      <div id="agent2Info"></div>
      
      <div id="agent2Actions" style="display: none;">
        <h3>Pending Actions</h3>
        <div id="pendingActions"></div>
      </div>
    </div>
    
    <!-- Statistics -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="messagesSent">0</div>
        <div class="stat-label">Messages Sent</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="messagesReceived">0</div>
        <div class="stat-label">Messages Received</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalTransfers">0</div>
        <div class="stat-label">Total Transfers</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalAmount">$0</div>
        <div class="stat-label">Total Amount</div>
      </div>
    </div>
    
    <!-- Message Log -->
    <h2>Message Log</h2>
    <div class="message-log" id="messageLog">
      <div class="message-entry">
        <span class="timestamp">[System]</span> Ready to create agents...
      </div>
    </div>
  </div>

  <script type="module">
    // Import TAP Agent from CDN or local build
    // For production, replace with: import { TapAgent } from '@taprsvp/agent';
    import { TapAgent, generatePrivateKey, generateUUID, createTransferMessage, createAuthorizeMessage, createRejectMessage } from '../dist/index.js';
    
    // Global state
    let agent1 = null;
    let agent2 = null;
    let stats = {
      sent: 0,
      received: 0,
      transfers: 0,
      totalAmount: 0
    };
    
    // Utility functions
    function log(message, type = 'info') {
      const logDiv = document.getElementById('messageLog');
      const timestamp = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'message-entry';
      entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function updateStats() {
      document.getElementById('messagesSent').textContent = stats.sent;
      document.getElementById('messagesReceived').textContent = stats.received;
      document.getElementById('totalTransfers').textContent = stats.transfers;
      document.getElementById('totalAmount').textContent = `$${stats.totalAmount.toFixed(2)}`;
    }
    
    function showError(message) {
      log(`‚ùå Error: ${message}`, 'error');
    }
    
    function showSuccess(message) {
      log(`‚úÖ ${message}`, 'success');
    }
    
    // Agent 1 functions
    document.getElementById('createAgent1').addEventListener('click', async () => {
      try {
        log('Creating Agent 1...');
        agent1 = await TapAgent.create({ keyType: 'Ed25519' });
        
        document.getElementById('agent1Info').innerHTML = `
          <p><strong>DID:</strong></p>
          <div class="did">${agent1.did}</div>
        `;
        
        document.getElementById('createAgent1').disabled = true;
        document.getElementById('exportKey1').disabled = false;
        document.getElementById('agent1Forms').style.display = 'block';
        
        showSuccess('Agent 1 created successfully!');
      } catch (error) {
        showError(`Failed to create Agent 1: ${error.message}`);
      }
    });
    
    document.getElementById('exportKey1').addEventListener('click', () => {
      if (!agent1) return;
      
      const privateKey = agent1.exportPrivateKey();
      navigator.clipboard.writeText(privateKey);
      showSuccess('Private key copied to clipboard!');
      log(`Private key: ${privateKey.substring(0, 20)}...`);
    });
    
    // Agent 2 functions
    document.getElementById('createAgent2').addEventListener('click', async () => {
      try {
        log('Creating Agent 2...');
        agent2 = await TapAgent.create({ keyType: 'Ed25519' });
        
        document.getElementById('agent2Info').innerHTML = `
          <p><strong>DID:</strong></p>
          <div class="did">${agent2.did}</div>
        `;
        
        document.getElementById('createAgent2').disabled = true;
        document.getElementById('exportKey2').disabled = false;
        document.getElementById('agent2Actions').style.display = 'block';
        
        showSuccess('Agent 2 created successfully!');
      } catch (error) {
        showError(`Failed to create Agent 2: ${error.message}`);
      }
    });
    
    document.getElementById('exportKey2').addEventListener('click', () => {
      if (!agent2) return;
      
      const privateKey = agent2.exportPrivateKey();
      navigator.clipboard.writeText(privateKey);
      showSuccess('Private key copied to clipboard!');
      log(`Private key: ${privateKey.substring(0, 20)}...`);
    });
    
    document.getElementById('importKey2').addEventListener('click', async () => {
      const privateKey = prompt('Enter private key (hex):');
      if (!privateKey) return;
      
      try {
        log('Importing Agent 2 from private key...');
        agent2 = await TapAgent.fromPrivateKey(privateKey, { keyType: 'Ed25519' });
        
        document.getElementById('agent2Info').innerHTML = `
          <p><strong>DID:</strong></p>
          <div class="did">${agent2.did}</div>
          <div class="success">Imported from private key</div>
        `;
        
        document.getElementById('createAgent2').disabled = true;
        document.getElementById('exportKey2').disabled = false;
        document.getElementById('agent2Actions').style.display = 'block';
        
        showSuccess('Agent 2 imported successfully!');
      } catch (error) {
        showError(`Failed to import Agent 2: ${error.message}`);
      }
    });
    
    // Transfer functions
    document.getElementById('sendTransfer').addEventListener('click', async () => {
      if (!agent1 || !agent2) {
        showError('Both agents must be created first!');
        return;
      }
      
      try {
        const amount = document.getElementById('transferAmount').value;
        const asset = document.getElementById('transferAsset').value;
        const memo = document.getElementById('transferMemo').value;
        
        log(`Agent 1 creating transfer of ${amount} ${asset}...`);
        
        // Create TAP-compliant transfer message
        const transfer = createTransferMessage({
          from: agent1.did,
          to: [agent2.did],
          amount: amount,
          asset: asset,
          originator: {
            '@id': agent1.did,
            '@type': 'https://schema.org/Person',
            name: 'Alice (Agent 1)'
          },
          beneficiary: {
            '@id': agent2.did,
            '@type': 'https://schema.org/Person',
            name: 'Bob (Agent 2)'
          },
          memo: memo,
          agents: []  // Could include agents for settlement, compliance, etc.
        });
        
        // Pack the message
        const packed = await agent1.pack(transfer);
        log(`Transfer packed (${packed.message.length} bytes)`);
        stats.sent++;
        
        // Simulate network transmission
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Agent 2 receives the message
        log('Agent 2 receiving transfer...');
        const received = await agent2.unpack(packed.message);
        stats.received++;
        stats.transfers++;
        stats.totalAmount += parseFloat(amount);
        
        log(`Transfer received: ${received.body.amount} ${received.body.asset}`);
        log(`From: ${received.from.substring(0, 50)}...`);
        log(`Memo: ${received.body.memo}`);
        
        // Show action buttons for Agent 2
        const actionsDiv = document.getElementById('pendingActions');
        actionsDiv.innerHTML = `
          <div class="success">Transfer received: ${amount} ${asset}</div>
          <button onclick="window.authorizeTransfer('${received.id}', '${agent1.did}')">Authorize</button>
          <button onclick="window.rejectTransfer('${received.id}', '${agent1.did}')">Reject</button>
        `;
        
        updateStats();
        showSuccess('Transfer sent successfully!');
        
        // Store for response handling
        window.lastTransfer = received;
        
      } catch (error) {
        showError(`Failed to send transfer: ${error.message}`);
      }
    });
    
    // Response functions (global for onclick handlers)
    window.authorizeTransfer = async (transactionId, senderDid) => {
      if (!agent2) return;
      
      try {
        log('Agent 2 authorizing transfer...');
        
        const authorize = createAuthorizeMessage({
          from: agent2.did,
          to: [senderDid],
          transaction_id: transactionId,
          settlement_address: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb7',
          expiry: new Date(Date.now() + 60 * 60 * 1000).toISOString(),
          thid: transactionId
        });
        
        const packed = await agent2.pack(authorize);
        stats.sent++;
        
        // Agent 1 receives authorization
        const received = await agent1.unpack(packed.message);
        stats.received++;
        
        log(`Authorization received by Agent 1`);
        log(`Settlement address: ${received.body.settlement_address}`);
        
        document.getElementById('pendingActions').innerHTML = 
          '<div class="success">Transfer authorized!</div>';
        
        updateStats();
        showSuccess('Transfer authorized!');
        
      } catch (error) {
        showError(`Failed to authorize: ${error.message}`);
      }
    };
    
    window.rejectTransfer = async (transactionId, senderDid) => {
      if (!agent2) return;
      
      try {
        log('Agent 2 rejecting transfer...');
        
        const reject = createRejectMessage({
          from: agent2.did,
          to: [senderDid],
          transaction_id: transactionId,
          reason: 'User rejected the transfer',
          thid: transactionId
        });
        
        const packed = await agent2.pack(reject);
        stats.sent++;
        
        // Agent 1 receives rejection
        const received = await agent1.unpack(packed.message);
        stats.received++;
        
        log(`Rejection received by Agent 1`);
        log(`Reason: ${received.body.reason}`);
        
        document.getElementById('pendingActions').innerHTML = 
          '<div class="error">Transfer rejected</div>';
        
        updateStats();
        
      } catch (error) {
        showError(`Failed to reject: ${error.message}`);
      }
    };
    
    // Test utilities
    window.testPerformance = async () => {
      if (!agent1 || !agent2) {
        showError('Create both agents first!');
        return;
      }
      
      log('Starting performance test...');
      const iterations = 100;
      const start = performance.now();
      
      for (let i = 0; i < iterations; i++) {
        const message = {
          id: generateUUID(),
          type: 'https://didcomm.org/basicmessage/2.0/message',
          from: agent1.did,
          to: [agent2.did],
          created_time: Date.now(),
          body: {
            content: `Test message ${i}`
          }
        };
        
        const packed = await agent1.pack(message);
        const unpacked = await agent2.unpack(packed.message);
      }
      
      const duration = performance.now() - start;
      const avgTime = duration / iterations;
      
      showSuccess(`Performance test complete!`);
      log(`${iterations} round trips in ${duration.toFixed(2)}ms`);
      log(`Average: ${avgTime.toFixed(2)}ms per round trip`);
    };
    
    // Initialize
    log('TAP Agent Browser Demo initialized');
    log('Create both agents to start messaging');
    
    // Expose for debugging
    window.TapAgent = TapAgent;
    window.agent1 = () => agent1;
    window.agent2 = () => agent2;
    window.generatePrivateKey = generatePrivateKey;
    window.generateUUID = generateUUID;
  </script>
</body>
</html>